<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadership Academy Ranking</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            color: #1e293b; /* Dark text for high contrast */
        }
        
        /* New Color Palette */
        .bg-light-bg { background-color: #f0f4f8; }
        .bg-card-bg { background-color: #ffffff; }
        .text-primary-blue { color: #3b82f6; }
        .bg-primary-blue { background-color: #3b82f6; }
        .text-accent-teal { color: #2dd4bf; }
        .bg-accent-teal { background-color: #2dd4bf; }
        .border-accent { border-color: #d1d5db; }

        /* Modern Table Styling */
        .table-header { background-color: #e2e8f0; }
        .table-row-even { background-color: #f8fafc; }
        .table-row-odd { background-color: #ffffff; }

        /* Horizontal Timeline Styling */
        .timeline-container {
            position: relative;
            overflow-x: auto;
            white-space: nowrap;
        }
        .timeline-milestone-card {
            display: inline-block;
            width: 280px;
            margin-right: 20px;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 12px -2px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .timeline-milestone-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px -4px rgba(0,0,0,0.15);
        }
        .timeline-milestone-card:last-child {
            margin-right: 0;
        }
        
        /* Progress Bar Styling */
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
            height: 1.25rem;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }

        /* Sort arrow styling */
        .sort-arrow {
            display: inline-block;
            margin-left: 0.5rem;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            vertical-align: middle;
            transition: transform 0.2s ease-in-out;
        }

        .sort-arrow.up {
            border-bottom: 5px solid #1e293b; /* Upward pointing triangle */
        }
        
        .sort-arrow.down {
            border-top: 5px solid #1e293b; /* Downward pointing triangle */
        }
    </style>
</head>
<body class="bg-light-bg text-slate-800 min-h-screen flex flex-col">

    <!-- Header Section with blurred background and increased size -->
    <header class="relative overflow-hidden py-24 text-center">
        <!-- Blurred Background Image Container -->
        <div class="absolute inset-0 z-0" style="
            background-image: url('Banner_.png'); 
            background-size: cover; 
            background-position: center; 
            filter: blur(3px);
        "></div>
        
        <!-- Semi-transparent overlay for better text readability -->
        <div class="absolute inset-0 z-10 bg-black bg-opacity-30"></div>
        
        <!-- Header Content (Text) -->
        <div class="relative z-20 container mx-auto px-4">
            <!-- Text on top -->
            <h1 class="text-white text-4xl md:text-6xl font-extrabold leading-tight">
                Leadership Academy
            </h1>
            <p class="text-white text-xl md:text-2xl font-light mt-2 opacity-90">
                Die Zukunft der F√ºhrung
            </p>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="w-full p-4 md:p-8 flex-grow">

        <!-- Timetable Section -->
        <section class="my-16 container mx-auto px-4 max-w-7xl">
            <!-- Heading is now left-aligned -->
            <h2 class="text-3xl font-bold mb-8 text-left">Dein Weg zum Leader</h2>
            <div class="bg-card-bg rounded-2xl p-6 md:p-10 shadow-xl overflow-hidden">
                <div id="timeline-milestones" class="timeline-container relative">
                    <!-- Milestones will be dynamically added here -->
                </div>
            </div>
        </section>

        <!-- Motivational Quote Section -->
        <section class="my-16 container mx-auto px-4 max-w-7xl">
            <div class="bg-card-bg rounded-2xl p-8 shadow-xl border-l-4 border-primary-blue text-center">
                <blockquote class="text-xl md:text-2xl font-light italic text-gray-600">
                    "Leadership is not about being in charge. It is about taking care of those in your charge."
                </blockquote>
                <cite class="block mt-4 text-right font-semibold text-primary-blue">- Simon Sinek</cite>
            </div>
        </section>

        <!-- Main Ranking Section -->
        <section class="my-16 container mx-auto px-4 max-w-7xl">
            <h2 class="text-3xl font-bold mb-6 text-left">Ranking üèÜ</h2>
            <div class="overflow-x-auto bg-card-bg rounded-2xl shadow-xl">
                <table class="min-w-full text-left">
                    <thead class="table-header">
                        <tr>
                            <!-- Adding data-sort-by attributes and a placeholder for the arrow -->
                            <!-- Using flexbox to ensure the arrow stays next to the text and adding whitespace-nowrap -->
                            <th scope="col" class="py-4 px-6 text-base font-bold cursor-pointer whitespace-nowrap" data-sort-by="rank">
                                <div class="flex items-center gap-2">
                                    Platz
                                </div>
                            </th>
                            <th scope="col" class="py-4 px-6 text-base font-bold cursor-pointer whitespace-nowrap" data-sort-by="name">
                                <div class="flex items-center gap-2">
                                    Name<span class="sort-arrow"></span>
                                </div>
                            </th>
                            <th scope="col" class="py-4 px-6 text-base font-bold text-center cursor-pointer whitespace-nowrap" data-sort-by="etsGesamt">
                                <div class="flex items-center gap-2">
                                    ETs Gesamt<span class="sort-arrow"></span>
                                </div>
                            </th>
                            <th scope="col" class="py-4 px-6 text-base font-bold text-center cursor-pointer whitespace-nowrap" data-sort-by="meinZiel">
                                <div class="flex items-center gap-2">
                                    Ziel<span class="sort-arrow"></span>
                                </div>
                            </th>
                            <th scope="col" class="py-4 px-6 text-base font-bold text-center cursor-pointer whitespace-nowrap" data-sort-by="meinGesamtziel">
                                <div class="flex items-center gap-2">
                                    Gesamtziel<span class="sort-arrow"></span>
                                </div>
                            </th>
                            <th scope="col" class="py-4 px-6 text-base font-bold text-center cursor-pointer whitespace-nowrap" data-sort-by="weeklyEts">
                                <div class="flex items-center gap-2">
                                    Wochen ETs<span class="sort-arrow"></span>
                                </div>
                            </th>
                            <th scope="col" class="py-4 px-6 text-base font-bold cursor-pointer whitespace-nowrap" data-sort-by="progressPercentage">
                                <div class="flex items-center gap-2">
                                    Challenge Fortschritt<span class="sort-arrow"></span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- Ranking data will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div id="pagination-controls" class="flex justify-center items-center gap-4 mt-8">
                <button id="prev-page" class="px-4 py-2 bg-primary-blue text-white rounded-full hover:bg-blue-600 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Zur√ºck
                </button>
                <span id="page-info" class="text-lg font-semibold text-gray-700"></span>
                <button id="next-page" class="px-4 py-2 bg-primary-blue text-white rounded-full hover:bg-blue-600 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Weiter
                </button>
            </div>
        </section>

        <!-- Dynamic Recruiter Ranking Section -->
        <section class="my-16 container mx-auto px-4 max-w-7xl">
            <!-- Title and Toggle Buttons -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 id="recruiter-ranking-title" class="text-3xl font-bold mb-4 sm:mb-0"></h2>
                <div class="inline-flex rounded-full bg-gray-200 p-1">
                    <button id="toggle-weekly" class="px-5 py-2 text-sm font-semibold rounded-full bg-white text-primary-blue shadow-md transition-colors duration-200">
                        Woche
                    </button>
                    <button id="toggle-overall" class="px-5 py-2 text-sm font-semibold rounded-full text-gray-700 hover:text-primary-blue transition-colors duration-200">
                        Gesamt
                    </button>
                </div>
            </div>
            
            <!-- Recruiter Cards Container -->
            <div id="recruiter-ranking-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Top 3 Recruiter cards will be dynamically added here -->
            </div>
        </section>
        
        <!-- Challenge Winners Section -->
        <section class="my-16 container mx-auto px-4 max-w-7xl">
            <h2 class="text-3xl font-bold mb-6 text-left">Unsere Challenge-Helden! üî•</h2>
            <div id="challenge-winners-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Winner cards will be dynamically added here -->
            </div>
        </section>

    </main>
    
    <!-- Footer -->
    <footer class="bg-white text-gray-500 text-center py-6 mt-12 shadow-inner">
        <p>&copy; 2025 Leadership Academy. Powering the next generation of leaders.</p>
    </footer>

    <script>
        // Start date of the program
        const startDate = new Date('2025-08-23T00:00:00');
        // Total number of weeks in the program
        const totalWeeks = 7;
        
        // Define the theme for the start of the program
        const startTheme = 'Recruiter Einstellung';

        // Define the themes for each week
        const weeklyThemes = [
            'Auftreten & Begeistern',
            'Closing & Sympathie im Verkauf',
            'Der perfekte ET',
            'Potential & Netzwerken',
            'Mitarbeiterf√ºhrung',
            '√úbung macht den Meister',
            'SIEGEREHRUNG'
        ];
        
        // Global variables for pagination and sorting
        let currentPage = 1;
        const rowsPerPage = 10;
        let data = []; // Store the full dataset globally
        let sortedData = []; // Store the currently sorted data for the main ranking table
        let currentSortColumn = 'progressPercentage'; // Default sort column is now 'progressPercentage'
        let sortDirection = 'desc'; // Default sort direction
        let currentRecruiterView = 'weekly'; // Set default view to 'weekly'

        // Google Sheet URL (needs to be handled by a backend proxy in a real-world scenario)
        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMuGKX0YGZNK5oVt7nJBtyGjCXXC288WC6uIRwZGb7WOdcWqVdo-WzwJai5rJYRx-11u19C4fF-j0u/pub?gid=923736018&single=true&output=csv';

        /**
         * Parses CSV text and extracts all required columns by searching for their headers.
         * It filters out non-personal names and the 'SUMME' row, and limits the data to the first 44 rows.
         * @param {string} text The CSV content as a string.
         * @param {number} weeklyEtsIndex The calculated index for the weekly ETs column.
         * @returns {Array<Object>} An array of objects with the processed data.
         */
        function parseCSV(text, weeklyEtsIndex) {
            const rows = text.trim().split('\n').map(row => row.split(','));
            
            let nameIndex = -1;
            let etsGesamtIndex = -1;
            let meinZielIndex = -1;
            let meinGesamtzielIndex = -1;
            let challengeFortschrittIndex = -1;
            
            // Search for the headers in all rows
            for (let i = 0; i < rows.length; i++) {
                const headerRow = rows[i].map(h => h.trim());
                if (nameIndex === -1 && headerRow.includes('Name')) {
                    nameIndex = headerRow.indexOf('Name');
                }
                if (etsGesamtIndex === -1 && headerRow.includes('ETs Gesamt')) {
                    etsGesamtIndex = headerRow.indexOf('ETs Gesamt');
                }
                if (meinZielIndex === -1 && headerRow.includes('MEIN ZIEL!')) {
                    meinZielIndex = headerRow.indexOf('MEIN ZIEL!');
                }
                if (meinGesamtzielIndex === -1 && headerRow.includes('Mein Gesamtziel')) {
                    meinGesamtzielIndex = headerRow.indexOf('Mein Gesamtziel');
                }
                if (challengeFortschrittIndex === -1 && headerRow.includes('Challenge Fortschritt')) {
                    challengeFortschrittIndex = headerRow.indexOf('Challenge Fortschritt');
                }
                // Stop searching once all headers are found
                if (nameIndex !== -1 && etsGesamtIndex !== -1 && meinZielIndex !== -1 && meinGesamtzielIndex !== -1 && challengeFortschrittIndex !== -1) {
                    break;
                }
            }

            // Log errors for missing columns
            if (nameIndex === -1) console.error("The required 'Name' column was not found.");
            if (etsGesamtIndex === -1) console.error("The required 'ETs Gesamt' column was not found.");
            if (meinZielIndex === -1) console.error("The required 'MEIN ZIEL!' column was not found.");
            if (meinGesamtzielIndex === -1) console.error("The required 'Mein Gesamtziel' column was not found.");
            if (challengeFortschrittIndex === -1) console.error("The required 'Challenge Fortschritt' column was not found.");
            
            const processedData = [];
            
            // Iterate through the data rows and extract the required data, stopping at row 44
            for (let i = 0; i < Math.min(rows.length, 44); i++) {
                const row = rows[i];
                const name = row[nameIndex] ? row[nameIndex].trim() : '';
                
                // Get ETs value
                const etsGesamt = (etsGesamtIndex !== -1 && row[etsGesamtIndex]) ? parseInt(row[etsGesamtIndex].trim(), 10) : 0;
                
                // Get 'Mein Ziel!' value
                const meinZiel = (meinZielIndex !== -1 && row[meinZielIndex]) ? parseInt(row[meinZielIndex].trim(), 10) : 0;
                
                // Get 'Mein Gesamtziel' value
                const meinGesamtziel = (meinGesamtzielIndex !== -1 && row[meinGesamtzielIndex]) ? parseInt(row[meinGesamtzielIndex].trim(), 10) : 0;

                // Get 'Wochen ETs' value based on the calculated index
                const weeklyEts = (weeklyEtsIndex !== -1 && row[weeklyEtsIndex]) ? parseInt(row[weeklyEtsIndex].trim(), 10) : 0;

                // Get 'Challenge Fortschritt' value and parse it
                let challengeFortschritt = (challengeFortschrittIndex !== -1 && row[challengeFortschrittIndex]) ? row[challengeFortschrittIndex].trim() : '0 von 0';
                let progressPercentage = 0;
                let completedChallenges = 0;
                const progressMatch = challengeFortschritt.match(/(\d+)\s+von\s+(\d+)/);
                if (progressMatch) {
                    const numerator = parseInt(progressMatch[1], 10);
                    const denominator = parseInt(progressMatch[2], 10);
                    if (denominator > 0) {
                        progressPercentage = (numerator / denominator) * 100;
                    }
                    completedChallenges = numerator;
                } else if (challengeFortschritt.includes('von 0 m√∂glichen')) {
                    // Handle "0 von 0 m√∂glichen" case explicitly
                    challengeFortschritt = '0 von 0';
                    progressPercentage = 0;
                    completedChallenges = 0;
                }

                // Filter out names that are not alphanumeric, single characters, or 'SUMME' etc.
                if (name && name.length > 1 && /[a-zA-Z]/.test(name) && name.toUpperCase() !== 'RDK' && !name.includes('BL') && name.toLowerCase() !== 'name' && name.toUpperCase() !== 'SUMME') {
                    processedData.push({
                        name: name,
                        etsGesamt: isNaN(etsGesamt) ? 0 : etsGesamt,
                        meinZiel: isNaN(meinZiel) ? 0 : meinZiel,
                        meinGesamtziel: isNaN(meinGesamtziel) ? 0 : meinGesamtziel,
                        weeklyEts: isNaN(weeklyEts) ? 0 : weeklyEts,
                        challengeFortschritt: challengeFortschritt,
                        progressPercentage: progressPercentage,
                        completedChallenges: completedChallenges
                    });
                }
            }
            return processedData;
        }

        /**
         * Renders the main ranking table with pagination, now including Challenge Fortschritt.
         * @param {Array<Object>} data - The processed data.
         * @param {number} page - The current page number to display.
         * @param {number} rowsPerPage - The number of rows to display per page.
         */
        function renderRankings(data, page, rowsPerPage) {
            const rankingBody = document.getElementById('ranking-body');
            rankingBody.innerHTML = ''; // Clear previous content

            if (data.length === 0) {
                // Update colspan to 7
                rankingBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Keine Ranking-Daten vorhanden.</td></tr>';
                return;
            }

            // Calculate start and end index for the current page
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = data.slice(start, end);

            paginatedData.forEach((item, index) => {
                const rank = start + index + 1;
                
                const rowClass = index % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                const row = `
                    <tr class="${rowClass} border-b border-gray-200 last:border-b-0">
                        <td class="py-4 px-6 font-bold text-gray-800">${rank}</td>
                        <td class="py-4 px-6 font-medium text-gray-700">${item.name}</td>
                        <td class="py-4 px-6 font-medium text-gray-700 text-center">${item.etsGesamt}</td>
                        <td class="py-4 px-6 font-medium text-gray-700 text-center">${item.meinZiel}</td>
                        <td class="py-4 px-6 font-medium text-gray-700 text-center">${item.meinGesamtziel}</td>
                        <td class="py-4 px-6 font-medium text-gray-700 text-center">${item.weeklyEts}</td>
                        <td class="py-4 px-6">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${item.progressPercentage}%;"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${item.challengeFortschritt}</div>
                        </td>
                    </tr>
                `;
                rankingBody.innerHTML += row;
            });
        }

        /**
         * Sets up the pagination controls.
         * @param {Array<Object>} data - The full dataset.
         */
        function setupPagination(data) {
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            const pageCount = Math.ceil(data.length / rowsPerPage);

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === pageCount || pageCount === 0;
            pageInfo.textContent = `Seite ${currentPage} von ${pageCount}`;

            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderRankings(data, currentPage, rowsPerPage);
                    setupPagination(data); // Update button states
                }
            };

            nextBtn.onclick = () => {
                if (currentPage < pageCount) {
                    currentPage++;
                    renderRankings(data, currentPage, rowsPerPage);
                    setupPagination(data); // Update button states
                }
            };
        }

        /**
         * Renders the top 3 recruiters based on the selected view (weekly or overall).
         * @param {Array<Object>} data - The full processed data.
         * @param {string} view - 'weekly' or 'overall'.
         */
        function renderTopRecruiters(data, view) {
            const container = document.getElementById('recruiter-ranking-container');
            const title = document.getElementById('recruiter-ranking-title');
            container.innerHTML = '';

            let sortedRecruiters = [];
            let valueKey = '';

            if (view === 'weekly') {
                sortedRecruiters = [...data].sort((a, b) => b.weeklyEts - a.weeklyEts).slice(0, 3);
                valueKey = 'weeklyEts';
            } else { // overall
                sortedRecruiters = [...data].sort((a, b) => b.etsGesamt - a.etsGesamt).slice(0, 3);
                valueKey = 'etsGesamt';
            }

            title.textContent = 'Bester Recruiter üèÜ';

            if (sortedRecruiters.length === 0) {
                 container.innerHTML = '<div class="col-span-3 text-center text-gray-500">Keine Recruiter-Daten verf√ºgbar.</div>';
                 return;
            }

            sortedRecruiters.forEach((recruiter, index) => {
                const medalEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                const valueText = valueKey === 'weeklyEts' ? recruiter.weeklyEts : recruiter.etsGesamt;
                const valueDescription = valueKey === 'weeklyEts' ? 'ETs in dieser Woche ausgemacht' : 'Gesamte ETs ausgemacht';
                
                const card = `
                    <div class="bg-card-bg rounded-xl p-6 text-center shadow-lg transform transition-transform duration-300 hover:scale-105 border-t-4 ${view === 'weekly' ? 'border-accent-teal' : 'border-primary-blue'}">
                        <div class="text-4xl mb-2">${medalEmoji}</div>
                        <h4 class="text-xl font-bold text-slate-800">${recruiter.name}</h4>
                        <p class="text-sm text-gray-500 mt-2">
                            ${valueDescription}
                        </p>
                        <p class="text-3xl font-bold text-primary-blue mb-2">${valueText}</p>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        /**
         * Toggles the active state of the view buttons.
         * @param {string} viewType - 'weekly' or 'overall'.
         */
        function toggleRecruiterView(viewType) {
            const weeklyBtn = document.getElementById('toggle-weekly');
            const overallBtn = document.getElementById('toggle-overall');
            
            if (viewType === 'weekly') {
                weeklyBtn.classList.add('bg-white', 'text-primary-blue', 'shadow-md');
                weeklyBtn.classList.remove('text-gray-700', 'hover:text-primary-blue');
                overallBtn.classList.remove('bg-white', 'text-primary-blue', 'shadow-md');
                overallBtn.classList.add('text-gray-700', 'hover:text-primary-blue');
            } else {
                overallBtn.classList.add('bg-white', 'text-primary-blue', 'shadow-md');
                overallBtn.classList.remove('text-gray-700', 'hover:text-primary-blue');
                weeklyBtn.classList.remove('bg-white', 'text-primary-blue', 'shadow-md');
                weeklyBtn.classList.add('text-gray-700', 'hover:text-primary-blue');
            }

            currentRecruiterView = viewType;
            renderTopRecruiters(data, currentRecruiterView);
        }

        /**
         * Renders a celebratory hall of fame for all who are currently "in the race".
         * A participant is in the race if they have completed all challenges up to the current week.
         * @param {Array<Object>} data - The full processed dataset.
         */
        function renderChallengeWinners(data) {
            const container = document.getElementById('challenge-winners-list');
            container.innerHTML = ''; // Clear previous content

            // Get the current week number to filter
            const currentWeek = getCurrentWeek();

            // Filter for individuals who have completed all challenges up to the current week
            const heroes = data.filter(person => person.completedChallenges === currentWeek && currentWeek > 0);
            
            // Sort heroes alphabetically
            heroes.sort((a, b) => a.name.localeCompare(b.name));

            if (heroes.length === 0) {
                // Display a motivational message if no one is in the race yet
                container.innerHTML = `
                    <div class="col-span-full text-center p-8 bg-gray-100 rounded-xl shadow-inner">
                        <p class="text-lg font-semibold text-gray-600">
                             Hier erscheinst du, sobald du dein selbst gestecktes Ziel erreicht hast!
                        </p>
                    </div>
                `;
                return;
            }

            // Create a card for each hero
            heroes.forEach(hero => {
                const heroCard = `
                    <div class="bg-card-bg rounded-xl p-6 text-center shadow-xl border-t-4 border-accent-teal transform transition-transform duration-300 hover:scale-105">
                        <div class="text-5xl mb-4">üöÄ</div>
                        <h4 class="text-2xl font-bold text-slate-800">${hero.name}</h4>
                        <p class="text-md text-gray-500 mt-2">
                            ist weiterhin im Rennen!
                        </p>
                        <p class="text-lg font-bold text-primary-blue mt-2">${hero.challengeFortschritt} gemeistert!</p>
                    </div>
                `;
                container.innerHTML += heroCard;
            });
        }

        /**
         * Function to update the timeline.
         */
        function updateTimeline() {
            const now = new Date();
            const timelineContainer = document.getElementById('timeline-milestones');
            timelineContainer.innerHTML = '';
            
            const milestones = [];
            // Changed the loop to iterate based on the new totalWeeks variable
            for (let i = 0; i <= totalWeeks; i++) {
                const milestoneDate = new Date(startDate.getTime() + (i * 7 * 24 * 60 * 60 * 1000));
                const isCurrent = now >= milestoneDate && (i === totalWeeks || now < new Date(startDate.getTime() + ((i + 1) * 7 * 24 * 60 * 60 * 1000)));
                const milestonePassed = now >= milestoneDate;

                milestones.push({
                    date: milestoneDate,
                    week: i,
                    isCurrent: isCurrent,
                    milestonePassed: milestonePassed
                });
            }

            milestones.forEach(m => {
                const statusEmoji = m.milestonePassed ? '‚úÖ' : '‚è≥';
                const statusText = m.isCurrent ? 'Aktuell' : (m.milestonePassed ? 'Abgeschlossen' : 'Bevorstehend');
                
                let theme = '';
                if (m.week === 0) {
                    theme = startTheme;
                } else if (m.week > 0 && m.week <= weeklyThemes.length) {
                    theme = weeklyThemes[m.week - 1];
                }

                const card = `
                    <div class="timeline-milestone-card bg-card-bg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-3xl">${statusEmoji}</span>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${m.isCurrent ? 'bg-accent-teal/20 text-accent-teal' : 'bg-gray-200 text-gray-500'}">
                                ${statusText}
                            </span>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-1">${m.week === 0 ? 'Start' : `Woche ${m.week}`}</h3>
                        ${theme ? `<p class="text-sm font-semibold text-accent-teal mb-2">${theme}</p>` : ''}
                        <p class="text-sm text-gray-500">${m.date.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSc-nopD_C8Ij6M9na7cJ9-obo1Y6PO3IrTWDfR7fisgT0lNiA/viewform" target="_blank" class="mt-3 inline-block text-sm text-primary-blue hover:text-blue-700 font-semibold transition-colors duration-200">
                            Feedback geben ‚Üí
                        </a>
                    </div>
                `;
                timelineContainer.innerHTML += card;
            });
        }
        
        /**
         * Calculates the current week number based on the start date.
         * @returns {number} The current week number (1-based).
         */
        function getCurrentWeek() {
            const now = new Date();
            const diffTime = Math.abs(now.getTime() - startDate.getTime());
            // Convert time difference to days, then to weeks
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            let currentWeek = Math.floor(diffDays / 7) + 1;

            // Cap the week number to the total number of weeks
            if (currentWeek > totalWeeks) {
                currentWeek = totalWeeks;
            }
            return currentWeek;
        }

        /**
         * Updates the UI to show the correct sorting arrow.
         * @param {string} column - The column being sorted.
         * @param {string} direction - The sort direction ('asc' or 'desc').
         */
        function updateSortArrows(column, direction) {
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.classList.remove('up', 'down');
            });
            const header = document.querySelector(`[data-sort-by="${column}"] .sort-arrow`);
            if (header) {
                if (direction === 'asc') {
                    header.classList.add('up');
                } else {
                    header.classList.add('down');
                }
            }
        }

        /**
         * Sorts the data based on a given column and toggles the sort direction.
         * @param {string} column - The data key to sort by.
         */
        function sortData(column) {
            // Check if the rank column is clicked, which is not sortable.
            if (column === 'rank') {
                return;
            }

            // If the same column is clicked, reverse the direction
            if (currentSortColumn === column) {
                sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                // Otherwise, set the new column and default to descending sort
                currentSortColumn = column;
                sortDirection = 'desc'; // Default to desc for new columns
            }
            
            // Perform the sort
            sortedData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle string and number sorting
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }
            });

            // Update the UI with the correct arrows
            updateSortArrows(currentSortColumn, sortDirection);

            // Reset to the first page and re-render
            currentPage = 1;
            renderRankings(sortedData, currentPage, rowsPerPage);
            setupPagination(sortedData);
        }

        /**
         * Initializes event listeners for the table headers to enable sorting.
         */
        function setupSorting() {
            const tableHeader = document.querySelector('thead');
            tableHeader.addEventListener('click', (event) => {
                const columnHeader = event.target.closest('[data-sort-by]');
                if (columnHeader) {
                    const sortBy = columnHeader.getAttribute('data-sort-by');
                    sortData(sortBy);
                }
            });
        }

        /**
         * Sets up event listeners for the new view toggle buttons.
         */
        function setupRecruiterToggle() {
            document.getElementById('toggle-weekly').addEventListener('click', () => {
                toggleRecruiterView('weekly');
            });
            document.getElementById('toggle-overall').addEventListener('click', () => {
                toggleRecruiterView('overall');
            });
            
            // Initial render based on the default view
            toggleRecruiterView(currentRecruiterView);
        }
        
        // Function to fetch and process data
        async function fetchDataAndRender() {
            try {
                // Note: In a real-world application, this fetch call must point to a backend proxy
                const response = await fetch(googleSheetUrl);
                const csvText = await response.text();

                // Calculate the correct column index for weekly ETs
                const currentWeek = getCurrentWeek();
                // 'W' is the 23rd letter, so its 0-based index is 22.
                // Each week adds 3 columns to the index.
                const weeklyEtsIndex = 22 + (currentWeek - 1) * 3;

                // Log raw and parsed data for debugging purposes
                console.log("Raw CSV Text:", csvText);
                data = parseCSV(csvText, weeklyEtsIndex); // Store full data
                
                sortedData = [...data]; // Create a copy for sorting the main table
                
                // Perform initial sort based on new default: 'progressPercentage' descending
                sortedData.sort((a, b) => b.progressPercentage - a.progressPercentage);
                
                // Update the global sort state after the initial manual sort
                currentSortColumn = 'progressPercentage';
                sortDirection = 'desc';

                // Initial render of the new dynamic recruiter section based on the default view
                renderTopRecruiters(data, currentRecruiterView);

                // Render the first page of the ranking
                renderRankings(sortedData, currentPage, rowsPerPage);
                // Setup pagination buttons
                setupPagination(sortedData);
                // Update sort arrows to reflect the initial sort
                updateSortArrows(currentSortColumn, sortDirection);
                
                // Render the challenge winners section
                renderChallengeWinners(data);
                
            } catch (error) {
                console.error("Fehler beim Abrufen der Daten:", error);
                document.getElementById('ranking-body').innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-400">Daten konnten nicht geladen werden.</td></tr>';
            }
        }
        
        // --- Initialization ---
        window.onload = () => {
            updateTimeline();
            fetchDataAndRender();
            setupSorting(); // Initialize sorting functionality
            setupRecruiterToggle(); // Initialize the new toggle functionality
        };
    </script>
</body>
</html>
